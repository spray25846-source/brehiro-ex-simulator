import streamlit as st
import pandas as pd

# --- アンコモン・マスターデータベース（検証済実測データ） ---
# データを13メモリ分、全20レベル分格納
UNCOMMON_DATA = {
    "EX0": {
        "HP": [2827, 2896, 2965, 3034, 3103, 3172, 3241, 3310, 3379, 3448, 3517, 3586, 3655],
        "攻撃": [789, 812, 835, 858, 881, 904, 927, 950, 973, 996, 1019, 1042, 1065],
        "魔攻": [370, 393, 416, 439, 462, 485, 508, 531, 554, 577, 600, 623, 646],
        "防御": [546, 569, 592, 615, 638, 661, 684, 707, 730, 753, 776, 799, 822],
        "魔防": [576, 599, 622, 645, 668, 691, 714, 737, 760, 783, 806, 829, 852],
        "敏捷": [122, 124, 126, 129, 131, 133, 136, 138, 140, 142, 145, 147, 149]
    },
    "EX1": {
        "HP": [2830, 2899, 2968, 3037, 3109, 3178, 3247, 3316, 3385, 3454, 3523, 3592, 3661],
        "攻撃": [790, 813, 836, 859, 883, 906, 929, 952, 975, 998, 1021, 1044, 1067],
        "魔攻": [371, 394, 417, 440, 464, 487, 510, 533, 556, 579, 602, 625, 648],
        "防御": [547, 570, 593, 616, 640, 663, 686, 709, 732, 755, 778, 801, 824],
        "魔防": [577, 600, 623, 646, 670, 693, 716, 739, 762, 785, 808, 831, 854],
        "敏捷": [122, 124, 126, 129, 131, 133, 136, 138, 140, 143, 145, 147, 150]
    },
    "EX2": {
        "HP": [2836, 2905, 2974, 3043, 3115, 3184, 3253, 3322, 3394, 3463, 3532, 3601, 3670],
        "攻撃": [792, 815, 838, 861, 885, 908, 931, 954, 978, 1001, 1024, 1047, 1070],
        "魔攻": [373, 396, 419, 442, 466, 489, 512, 535, 559, 582, 605, 628, 651],
        "防御": [549, 572, 595, 618, 642, 665, 688, 711, 735, 758, 781, 804, 827],
        "魔防": [579, 602, 625, 648, 672, 695, 718, 741, 765, 788, 811, 834, 857],
        "敏捷": [122, 124, 127, 129, 131, 134, 136, 138, 141, 143, 145, 148, 150]
    },
    "EX3": {
        "HP": [2845, 2914, 2986, 3055, 3127, 3196, 3268, 3337, 3409, 3478, 3550, 3619, 3688],
        "攻撃": [795, 818, 842, 865, 889, 912, 936, 959, 983, 1006, 1030, 1053, 1076],
        "魔攻": [376, 399, 423, 446, 470, 493, 517, 540, 564, 587, 611, 634, 657],
        "防御": [552, 575, 599, 622, 646, 669, 693, 716, 740, 763, 787, 810, 833],
        "魔防": [582, 605, 629, 652, 676, 699, 723, 746, 770, 793, 817, 840, 863],
        "敏捷": [122, 125, 127, 129, 132, 134, 136, 139, 141, 143, 146, 148, 150]
    },
    "EX4": {
        "HP": [2851, 2920, 2992, 3061, 3133, 3202, 3274, 3346, 3415, 3487, 3556, 3628, 3697],
        "攻撃": [797, 820, 844, 867, 891, 914, 938, 962, 985, 1009, 1032, 1056, 1079],
        "魔攻": [378, 401, 425, 448, 472, 495, 519, 543, 566, 590, 613, 637, 660],
        "防御": [554, 577, 601, 624, 648, 671, 695, 719, 742, 766, 789, 813, 836],
        "魔防": [584, 607, 631, 654, 678, 701, 725, 749, 772, 796, 819, 843, 866],
        "敏捷": [123, 125, 127, 130, 132, 134, 137, 139, 141, 144, 146, 148, 151]
    },
    "EX5": {
        "HP": [2893, 2968, 3040, 3115, 3187, 3262, 3337, 3409, 3484, 3559, 3631, 3706, 3778],
        "攻撃": [811, 836, 860, 885, 909, 934, 959, 983, 1008, 1033, 1057, 1082, 1106],
        "魔攻": [392, 417, 441, 466, 490, 515, 540, 564, 589, 614, 638, 663, 687],
        "防御": [568, 593, 617, 642, 666, 691, 716, 740, 765, 790, 814, 839, 863],
        "魔防": [598, 623, 647, 672, 696, 721, 746, 770, 795, 820, 844, 869, 893],
        "敏捷": [124, 126, 129, 131, 134, 136, 139, 141, 144, 146, 149, 151, 153]
    },
    "EX6": {
        "HP": [2899, 2971, 3046, 3121, 3196, 3268, 3343, 3418, 3490, 3565, 3640, 3715, 3787],
        "攻撃": [813, 837, 862, 887, 912, 936, 961, 986, 1010, 1035, 1060, 1085, 1109],
        "魔攻": [394, 418, 443, 468, 493, 517, 542, 567, 591, 616, 641, 666, 690],
        "防御": [570, 594, 619, 644, 669, 693, 718, 743, 767, 792, 817, 842, 866],
        "魔防": [600, 624, 649, 674, 699, 723, 748, 773, 797, 822, 847, 872, 896],
        "敏捷": [124, 127, 129, 132, 134, 136, 139, 141, 144, 146, 149, 151, 154]
    },
    "EX7": {
        "HP": [2908, 2983, 3058, 3133, 3208, 3283, 3358, 3433, 3508, 3580, 3655, 3730, 3805],
        "攻撃": [816, 841, 866, 891, 916, 941, 966, 991, 1016, 1040, 1065, 1090, 1115],
        "魔攻": [397, 422, 447, 472, 497, 522, 547, 572, 597, 621, 646, 671, 696],
        "防御": [573, 598, 623, 648, 673, 698, 723, 748, 773, 797, 822, 847, 872],
        "魔防": [603, 628, 653, 678, 703, 728, 753, 778, 803, 827, 852, 877, 902],
        "敏捷": [124, 127, 129, 132, 134, 137, 139, 142, 144, 147, 149, 152, 154]
    },
    "EX8": {
        "HP": [2911, 2989, 3064, 3139, 3214, 3289, 3364, 3439, 3514, 3589, 3664, 3739, 3814],
        "攻撃": [817, 843, 868, 893, 918, 943, 968, 993, 1018, 1043, 1068, 1093, 1118],
        "魔攻": [398, 424, 449, 474, 499, 524, 549, 574, 599, 624, 649, 674, 699],
        "防御": [574, 600, 625, 650, 675, 700, 725, 750, 775, 800, 825, 850, 875],
        "魔防": [604, 630, 655, 680, 705, 730, 755, 780, 805, 830, 855, 880, 905],
        "敏捷": [125, 127, 130, 132, 135, 137, 140, 142, 145, 147, 150, 152, 155]
    },
    "EX9": {
        "HP": [2923, 2998, 3073, 3151, 3226, 3301, 3379, 3454, 3529, 3604, 3682, 3757, 3832],
        "攻撃": [821, 846, 871, 897, 922, 947, 973, 998, 1023, 1048, 1074, 1099, 1124],
        "魔攻": [402, 427, 452, 478, 503, 528, 554, 579, 604, 629, 655, 680, 705],
        "防御": [578, 603, 628, 654, 679, 704, 730, 755, 780, 805, 831, 856, 881],
        "魔防": [608, 633, 658, 684, 709, 734, 760, 785, 810, 835, 861, 886, 911],
        "敏捷": [125, 127, 130, 133, 135, 138, 140, 143, 145, 148, 150, 153, 155]
    },
    "EX10": {
        "HP": [2962, 3040, 3118, 3196, 3274, 3355, 3433, 3511, 3589, 3670, 3748, 3826, 3904],
        "攻撃": [834, 860, 886, 912, 938, 965, 991, 1017, 1043, 1070, 1096, 1122, 1148],
        "魔攻": [415, 441, 467, 493, 519, 546, 572, 598, 624, 651, 677, 703, 729],
        "防御": [591, 617, 643, 669, 695, 722, 748, 774, 800, 827, 853, 879, 905],
        "魔防": [621, 647, 673, 699, 725, 752, 778, 804, 830, 857, 883, 909, 935],
        "敏捷": [126, 129, 131, 134, 137, 139, 142, 145, 147, 150, 152, 155, 158]
    },
    "EX11": {
        "HP": [2971, 3049, 3130, 3208, 3289, 3367, 3448, 3526, 3604, 3685, 3763, 3844, 3922],
        "攻撃": [837, 863, 890, 916, 943, 969, 996, 1022, 1048, 1075, 1101, 1128, 1154],
        "魔攻": [418, 444, 471, 497, 524, 550, 577, 603, 629, 656, 682, 709, 735],
        "防御": [594, 620, 647, 673, 700, 726, 753, 779, 805, 832, 858, 885, 911],
        "魔防": [624, 650, 677, 703, 730, 756, 783, 809, 835, 862, 888, 915, 941],
        "敏捷": [127, 129, 132, 134, 137, 140, 142, 145, 148, 150, 153, 156, 158]
    },
    "EX12": {
        "HP": [2974, 3055, 3136, 3214, 3295, 3373, 3454, 3532, 3613, 3691, 3772, 3853, 3931],
        "攻撃": [838, 865, 892, 918, 945, 971, 998, 1024, 1051, 1077, 1104, 1131, 1157],
        "魔攻": [419, 446, 473, 499, 526, 552, 579, 605, 632, 658, 685, 712, 738],
        "防御": [595, 622, 649, 675, 702, 728, 755, 781, 808, 834, 861, 888, 914],
        "魔防": [625, 652, 679, 705, 732, 758, 785, 811, 838, 864, 891, 918, 944],
        "敏捷": [127, 129, 132, 135, 137, 140, 143, 145, 148, 151, 153, 156, 159]
    },
    "EX13": {
        "HP": [2986, 3064, 3145, 3226, 3307, 3388, 3466, 3547, 3628, 3709, 3790, 3868, 3949],
        "攻撃": [842, 868, 895, 922, 949, 976, 1002, 1029, 1056, 1083, 1110, 1136, 1163],
        "魔攻": [423, 449, 476, 503, 530, 557, 583, 610, 637, 664, 691, 717, 744],
        "防御": [599, 625, 652, 679, 706, 733, 759, 786, 813, 840, 867, 893, 920],
        "魔防": [629, 655, 682, 709, 736, 763, 789, 816, 843, 870, 897, 923, 950],
        "敏捷": [127, 130, 132, 135, 138, 140, 143, 146, 148, 151, 154, 156, 159]
    },
    "EX14": {
        "HP": [2989, 3070, 3151, 3232, 3313, 3394, 3475, 3556, 3637, 3715, 3796, 3877, 3958],
        "攻撃": [843, 870, 897, 924, 951, 978, 1005, 1032, 1059, 1085, 1112, 1139, 1166],
        "魔攻": [424, 451, 478, 505, 532, 559, 586, 613, 640, 666, 693, 720, 747],
        "防御": [600, 627, 654, 681, 708, 735, 762, 789, 816, 842, 869, 896, 923],
        "魔防": [630, 657, 684, 711, 738, 765, 792, 819, 846, 872, 899, 926, 953],
        "敏捷": [127, 130, 133, 135, 138, 141, 143, 146, 149, 151, 154, 157, 159]
    },
    "EX15": {
        "HP": [3034, 3118, 3202, 3286, 3370, 3451, 3535, 3619, 3703, 3787, 3871, 3955, 4039],
        "攻撃": [858, 886, 914, 942, 970, 997, 1025, 1053, 1081, 1109, 1137, 1165, 1193],
        "魔攻": [439, 467, 495, 523, 551, 578, 606, 634, 662, 690, 718, 746, 774],
        "防御": [615, 643, 671, 699, 727, 754, 782, 810, 838, 866, 894, 922, 950],
        "魔防": [645, 673, 701, 729, 757, 784, 812, 840, 868, 896, 924, 952, 980],
        "敏捷": [129, 131, 134, 137, 140, 143, 145, 148, 151, 154, 157, 159, 162]
    },
    "EX16": {
        "HP": [3037, 3121, 3205, 3292, 3376, 3460, 3544, 3628, 3712, 3796, 3880, 3964, 4048],
        "攻撃": [859, 887, 915, 944, 972, 1000, 1028, 1056, 1084, 1112, 1140, 1168, 1196],
        "魔攻": [440, 468, 496, 525, 553, 581, 609, 637, 665, 693, 721, 749, 777],
        "防御": [616, 644, 672, 701, 729, 757, 785, 813, 841, 869, 897, 925, 953],
        "魔防": [646, 674, 702, 731, 759, 787, 815, 843, 871, 899, 927, 955, 983],
        "敏捷": [129, 132, 134, 137, 140, 143, 146, 148, 151, 154, 157, 160, 162]
    },
    "EX17": {
        "HP": [3049, 3133, 3217, 3301, 3388, 3472, 3556, 3643, 3727, 3811, 3895, 3982, 4066],
        "攻撃": [863, 891, 919, 947, 976, 1004, 1032, 1061, 1089, 1117, 1145, 1174, 1202],
        "魔攻": [444, 472, 500, 528, 557, 585, 613, 642, 670, 698, 726, 755, 783],
        "防御": [620, 648, 676, 704, 733, 761, 789, 818, 846, 874, 902, 931, 959],
        "魔防": [650, 678, 706, 734, 763, 791, 819, 848, 876, 904, 932, 961, 989],
        "敏捷": [129, 132, 135, 138, 140, 143, 146, 149, 152, 155, 157, 160, 163]
    },
    "EX18": {
        "HP": [3052, 3139, 3223, 3307, 3394, 3478, 3565, 3649, 3733, 3820, 3904, 3991, 4075],
        "攻撃": [864, 893, 921, 949, 978, 1006, 1035, 1063, 1091, 1120, 1148, 1177, 1205],
        "魔攻": [445, 474, 502, 530, 559, 587, 616, 644, 672, 701, 729, 758, 786],
        "防御": [621, 650, 678, 706, 735, 763, 792, 820, 848, 877, 905, 934, 962],
        "魔防": [651, 680, 708, 736, 765, 793, 822, 850, 878, 907, 935, 964, 992],
        "敏捷": [129, 132, 135, 138, 141, 143, 146, 149, 152, 155, 158, 161, 163]
    },
    "EX19": {
        "HP": [3058, 3142, 3229, 3313, 3400, 3484, 3571, 3655, 3742, 3826, 3913, 4000, 4084],
        "攻撃": [866, 894, 923, 951, 980, 1008, 1037, 1065, 1094, 1122, 1151, 1180, 1208],
        "魔攻": [447, 475, 504, 532, 561, 589, 618, 646, 675, 703, 732, 761, 789],
        "防御": [623, 651, 680, 708, 737, 765, 794, 822, 851, 879, 908, 937, 965],
        "魔防": [653, 681, 710, 738, 767, 795, 824, 852, 881, 909, 938, 967, 995],
        "敏捷": [129, 132, 135, 138, 141, 144, 147, 149, 152, 155, 158, 161, 164]
    },
    "EX20": {
        "HP": [3100, 3190, 3277, 3367, 3454, 3544, 3634, 3721, 3811, 3898, 3988, 4075, 4165],
        "攻撃": [880, 910, 939, 969, 998, 1028, 1058, 1087, 1117, 1146, 1176, 1205, 1235],
        "魔攻": [461, 491, 520, 550, 579, 609, 639, 668, 698, 727, 757, 786, 816],
        "防御": [637, 667, 696, 726, 755, 785, 815, 844, 874, 903, 933, 962, 992],
        "魔防": [667, 697, 726, 756, 785, 815, 845, 874, 904, 933, 963, 992, 1022],
        "敏捷": [131, 134, 137, 140, 143, 146, 149, 152, 155, 157, 160, 163, 166]
    }
}

st.set_page_config(page_title="BFH 限界突破ステータスシミュレーター", layout="wide")

# CSS: カスタム背景色、罫線、強調表示
st.markdown("""
    <style>
    .stApp { background-color: #0e1117; color: #ffffff; }
    div.stButton > button:first-child {
        border: 2px solid #00ffcc; background-color: #1f2937; color: #00ffcc;
        width: 100%; height: 3.5em; font-weight: bold; border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
    }
    div.stButton > button:hover { background-color: #00ffcc; color: #0e1117; }
    
    .custom-table { width: 100%; border-collapse: collapse; margin-top: 20px; color: white; border: 1px solid #444; }
    .custom-table th, .custom-table td { border: 1px solid #444; padding: 10px; text-align: center; }
    
    /* 累計列の背景色分け（一段暗く） */
    .cum-cell { background-color: #161b22; }
    .inc-cell { background-color: #1f2937; }

    /* 5区切りの文字色強調（青色） */
    .highlight-blue { color: #58a6ff !important; font-weight: bold; }

    /* ステータス別のヘッダー色 */
    .header-hp { background-color: #E6B422; color: #000; font-weight: bold; }
    .header-atk { background-color: #C94627; color: #FFF; font-weight: bold; }
    .header-mag { background-color: #234794; color: #FFF; font-weight: bold; }
    .header-def { background-color: #6E4427; color: #FFF; font-weight: bold; }
    .header-mdf { background-color: #4C9AC2; color: #000; font-weight: bold; }
    .header-agi { background-color: #2D6D3B; color: #FFF; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

st.title("⚔️ BFH 限界突破ステータスシミュレーター")
st.caption("アンコモン実測データに基づくシミュレーション（検証用）")

# --- 1. ユニット設定 ---
st.header("1. ユニット基本設定")
st.selectbox("レアリティを選択してください", ["Uncommon"])
st.info("※現在、アンコモンのみ実測データによる検証シミュレーションが可能です。")

st.divider()

# --- 2. メモリ設定 ---
st.header("2. 成長傾向（メモリ値）設定")
r1_c1, r1_c2, r1_c3 = st.columns(3)
with r1_c1: m_hp  = st.slider("HPメモリ", 0, 12, 6)
with r1_c2: m_atk = st.slider("攻撃メモリ", 0, 12, 6)
with r1_c3: m_mag = st.slider("魔攻メモリ", 0, 12, 6)

r2_c1, r2_c2, r2_c3 = st.columns(3)
with r2_c1: m_def = st.slider("防御メモリ", 0, 12, 6)
with r2_c2: m_mdf = st.slider("魔防メモリ", 0, 12, 6)
with r2_c3: m_agi = st.slider("敏捷メモリ", 0, 12, 6)

st.divider()

# --- 3. シミュレーション ---
if st.button("シミュレーションを実行する"):
    st.header("3. 限界突破段階別 加算ボーナス詳細")
    
    html = """<table class="custom-table"><thead><tr>
    <th rowspan="2" style="background-color: #1f2937;">EXレベル</th>
    <th colspan="2" class="header-hp">HP</th><th colspan="2" class="header-atk">攻撃</th>
    <th colspan="2" class="header-mag">魔攻</th><th colspan="2" class="header-def">防御</th>
    <th colspan="2" class="header-mdf">魔防</th><th colspan="2" class="header-agi">敏捷</th>
    </tr><tr style="background-color: #1f2937;">
    <th>累計</th><th>増加</th><th>累計</th><th>増加</th><th>累計</th><th>増加</th>
    <th>累計</th><th>増加</th><th>累計</th><th>増加</th><th>累計</th><th>増加</th>
    </tr></thead><tbody>"""
    
    stats_keys = ["HP", "攻撃", "魔攻", "防御", "魔防", "敏捷"]
    mems = [m_hp, m_atk, m_mag, m_def, m_mdf, m_agi]
    
    def get_val(ex_key, s_key, m_val):
        return UNCOMMON_DATA[ex_key][s_key][m_val]

    prev_cums = {s: 0 for s in stats_keys}
    
    for ex in range(1, 21):
        ex_key = f"EX{ex}"
        # 5レベルごとの判定
        is_highlight = (ex % 5 == 0)
        h_class = "highlight-blue" if is_highlight else ""
        
        html += f"<tr><td class='{h_class}'>+{ex}</td>"
        
        for s_idx, s_key in enumerate(stats_keys):
            # 累計 = 対象レベルの実数値 - EX0の実数値
            current_total = get_val(ex_key, s_key, mems[s_idx]) - get_val("EX0", s_key, mems[s_idx])
            increase = current_total - prev_cums[s_key]
            
            html += f"<td class='cum-cell {h_class}'>+{current_total}</td>"
            html += f"<td class='inc-cell {h_class}'>+{increase}</td>"
            
            prev_cums[s_key] = current_total
        html += "</tr>"
        
    html += "</tbody></table>"
    st.markdown(html, unsafe_allow_html=True)
else:
    st.info("「シミュレーションを実行する」ボタンを押すと、検証データに基づく結果が表示されます。")

